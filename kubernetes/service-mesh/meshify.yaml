---
kind: Mesh
apiVersion: servicemesh.oci.oracle.com/v1beta1
metadata:
  name: oci-sm-app
  namespace: oci-sm-app
spec:
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  certificateAuthorities:
    - id: ocid1.certificateauthority.oc1.phx.amaaaaaassl65iqa36wfx2wvwjuvsy23acpx3o6qzqm5vkrbg4haqw5bjucq
  mtls:
    minimum: PERMISSIVE
---
##################################################################################################
# Client service
##################################################################################################
kind: VirtualService
apiVersion: servicemesh.oci.oracle.com/v1beta1
metadata:
  name: client
  namespace: oci-sm-app
spec:
  mesh:
    ref:
      name: oci-sm-app
  defaultRoutingPolicy:
    type: UNIFORM
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  hosts:
    - client
    - client:8080
---
kind: VirtualDeployment
apiVersion: servicemesh.oci.oracle.com/v1beta1
metadata:
  name: client-v1
  namespace: oci-sm-app
spec:
  virtualService:
    ref:
      name: client
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  listener:
    - port: 8080
      protocol: HTTP
  accessLogging:
    isEnabled: true
  serviceDiscovery:
    type: DNS
    hostname: client
---
apiVersion: servicemesh.oci.oracle.com/v1beta1
kind: VirtualServiceRouteTable
metadata:
  name: client-route-table
  namespace: oci-sm-app
spec:
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  virtualService:
    ref:
      name: client
  routeRules:
    - httpRoute:
        destinations:
          - virtualDeployment:
              ref:
                name: client-v1
            weight: 100
---
##################################################################################################
# Catalog service
##################################################################################################
kind: VirtualService
apiVersion: servicemesh.oci.oracle.com/v1beta1
metadata:
  name: catalog
  namespace: oci-sm-app
spec:
  mesh:
    ref:
      name: oci-sm-app
  defaultRoutingPolicy:
    type: UNIFORM
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  hosts:
    - catalog
    - catalog:8080
---
kind: VirtualDeployment
apiVersion: servicemesh.oci.oracle.com/v1beta1
metadata:
  name: catalog-v1
  namespace: oci-sm-app
spec:
  virtualService:
    ref:
      name: catalog
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  listener:
    - port: 8080
      protocol: HTTP
  accessLogging:
    isEnabled: true
  serviceDiscovery:
    type: DNS
    hostname: catalog
---
kind: VirtualDeployment
apiVersion: servicemesh.oci.oracle.com/v1beta1
metadata:
  name: catalog-v2
  namespace: oci-sm-app
spec:
  virtualService:
    ref:
      name: catalog
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  listener:
    - port: 8080
      protocol: HTTP
  accessLogging:
    isEnabled: true
  serviceDiscovery:
    type: DNS
    hostname: catalog
---
apiVersion: servicemesh.oci.oracle.com/v1beta1
kind: VirtualServiceRouteTable
metadata:
  name: catalog-route-table
  namespace: oci-sm-app
spec:
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  virtualService:
    ref:
      name: catalog
  routeRules:
    - httpRoute:
        destinations:
          - virtualDeployment:
              ref:
                name: catalog-v1
            weight: 80
          - virtualDeployment:
              ref:
                name: catalog-v2
            weight: 20
---
kind: IngressGateway
apiVersion: servicemesh.oci.oracle.com/v1beta1
metadata:
  name: oci-sm-app-ingress-gateway
  namespace: oci-sm-app
spec:
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  mesh:
    ref:
      name: oci-sm-app
  hosts:
    - name: host
      hostnames:
        - sm.shukawam.com
        - sm.shukawam.com:80
        - sm.shukawam.com:443
      listeners:
        - port: 8080
          protocol: HTTP
          tls:
            serverCertificate:
              ociTlsCertificate:
                certificateId: ocid1.certificate.oc1.phx.amaaaaaassl65iqaxcxstx6tywvftmozdnnuyns56as5hpmewrwjwe6gcyhq
            mode: TLS
          # tls:
          #   mode: DISABLED
  accessLogging:
    isEnabled: true
---
apiVersion: servicemesh.oci.oracle.com/v1beta1
kind: IngressGatewayRouteTable
metadata:
  name: oci-sm-app-ingress-gateway-route-table
  namespace: oci-sm-app
spec:
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  ingressGateway:
    ref:
      name: oci-sm-app-ingress-gateway
  routeRules:
    - httpRoute:
        ingressGatewayHost:
          name: host
        destinations:
          - virtualService:
              ref:
                name: client
---
kind: AccessPolicy
apiVersion: servicemesh.oci.oracle.com/v1beta1
metadata:
  name: oci-sm-app-ingress-policy
  namespace: oci-sm-app
spec:
  mesh:
    ref:
      name: oci-sm-app
  compartmentId: ocid1.compartment.oc1..aaaaaaaanjtbllhqxcg67dq7em3vto2mvsbc6pbgk4pw6cx37afzk3tngmoa
  rules:
    - action: ALLOW
      source:
        virtualService:
          ref:
            name: client
      destination:
        virtualService:
          ref:
            name: catalog
    - action: ALLOW
      source:
        ingressGateway:
          ref:
            name: oci-sm-app-ingress-gateway
      destination:
        virtualService:
          ref:
            name: client
---